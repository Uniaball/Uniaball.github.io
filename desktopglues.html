<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DesktopGlues - Releases</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header style="margin-bottom: 32px;">
            <a href="index.html" class="btn" style="margin-bottom: 16px;">
                <i class="material-icons">arrow_back</i>
                <span>返回首页</span>
            </a>
            
            <div class="card" style="padding: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <h1 style="font-size: 24px; font-weight: 500;">DesktopGlues Releases</h1>
                    <div class="chip">GitHub API</div>
                </div>
                <p style="color: var(--md-on-surface-variant); margin-bottom: 16px;">Uniaball 桌面端构建下载</p>
                
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(var(--md-primary-rgb), 0.05); border-radius: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1;">
                        <div style="position: relative;">
                            <input type="checkbox" id="mirrorToggle" style="display: none;">
                            <div class="toggle-track" style="width: 40px; height: 20px; background: var(--md-outline-variant); border-radius: 10px; position: relative; transition: background 0.2s;">
                                <div class="toggle-thumb" style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                            </div>
                        </div>
                        <span style="font-size: 14px; font-weight: 500;">使用 bgithub.xyz 镜像下载</span>
                    </label>
                    <div class="chip chip-primary" id="mirrorStatus" style="opacity: 0.6;">OFF</div>
                </div>
            </div>
        </header>

        <main>
            <div class="card">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 500;">可用版本</h2>
                    <div class="select-container" style="width: 200px;">
                        <select id="platformSelect" class="select">
                            <option value="all">所有平台</option>
                            <option value="windows">Windows</option>
                            <option value="macos">macOS</option>
                            <option value="linux">Linux</option>
                        </select>
                    </div>
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>正在加载 Releases...</p>
                </div>

                <div id="releasesContainer" style="display: none;">
                    <!-- Releases 将在这里动态加载 -->
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="icon">
                        <i class="material-icons">inventory_2</i>
                    </div>
                    <p>暂无可用版本</p>
                </div>

                <div id="errorState" class="error-state" style="display: none;">
                    <div class="icon">
                        <i class="material-icons">error</i>
                    </div>
                    <p id="errorMessage">加载失败</p>
                </div>
            </div>
        </main>

        <footer style="margin-top: 32px; text-align: center; color: var(--md-on-surface-variant); font-size: 14px;">
            <p>通过 GitHub API 获取 · 使用 nightly.link 下载 · 最后更新: <span id="lastUpdate">-</span></p>
        </footer>
    </div>

    <script>
        const MIRROR_TOGGLE_KEY = 'desktopglues_use_mirror';
        const REPO_OWNER = 'Uniaball';
        const REPO_NAME = 'DesktopGlues';

        let useMirror = localStorage.getItem(MIRROR_TOGGLE_KEY) === 'true';
        let releasesData = [];

        document.addEventListener('DOMContentLoaded', function() {
            initMirrorToggle();
            loadReleases();
            setupPlatformFilter();
        });

        function initMirrorToggle() {
            const toggle = document.getElementById('mirrorToggle');
            const status = document.getElementById('mirrorStatus');
            
            toggle.checked = useMirror;
            updateToggleUI();
            
            toggle.addEventListener('change', function() {
                useMirror = this.checked;
                localStorage.setItem(MIRROR_TOGGLE_KEY, useMirror);
                updateToggleUI();
                updateDownloadLinks();
            });
        }

        function updateToggleUI() {
            const toggle = document.getElementById('mirrorToggle');
            const track = document.querySelector('.toggle-track');
            const thumb = document.querySelector('.toggle-thumb');
            const status = document.getElementById('mirrorStatus');
            
            if (useMirror) {
                track.style.background = 'var(--md-primary)';
                thumb.style.transform = 'translateX(20px)';
                status.textContent = 'ON';
                status.style.opacity = '1';
            } else {
                track.style.background = 'var(--md-outline-variant)';
                thumb.style.transform = 'translateX(0)';
                status.textContent = 'OFF';
                status.style.opacity = '0.6';
            }
        }

        function convertToMirrorUrl(githubUrl) {
            if (!useMirror || !githubUrl) return githubUrl;
            return githubUrl.replace('github.com', 'bgithub.xyz');
        }

        async function loadReleases() {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases`);
                
                if (!response.ok) {
                    throw new Error(`GitHub API 错误: ${response.status}`);
                }
                
                releasesData = await response.json();
                displayReleases(releasesData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('releasesContainer').style.display = 'block';
                
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('加载失败:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        function displayReleases(releases) {
            const container = document.getElementById('releasesContainer');
            container.innerHTML = '';
            
            if (!releases || releases.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            releases.forEach(release => {
                const releaseElement = createReleaseElement(release);
                container.appendChild(releaseElement);
            });
        }

        function createReleaseElement(release) {
            const div = document.createElement('div');
            div.className = 'list-item';
            
            const assets = release.assets || [];
            const windowsAssets = assets.filter(a => a.name.includes('.exe') || a.name.includes('.msi') || a.name.includes('windows'));
            const macosAssets = assets.filter(a => a.name.includes('.dmg') || a.name.includes('.pkg') || a.name.includes('macos'));
            const linuxAssets = assets.filter(a => a.name.includes('.deb') || a.name.includes('.rpm') || a.name.includes('linux'));
            
            let platformTags = '';
            if (windowsAssets.length > 0) platformTags += '<span class="chip" style="margin-right: 8px;">Windows</span>';
            if (macosAssets.length > 0) platformTags += '<span class="chip" style="margin-right: 8px;">macOS</span>';
            if (linuxAssets.length > 0) platformTags += '<span class="chip" style="margin-right: 8px;">Linux</span>';
            
            let downloadLinks = '';
            assets.forEach(asset => {
                const originalUrl = asset.browser_download_url;
                const displayUrl = convertToMirrorUrl(originalUrl);
                downloadLinks += `
                    <div style="margin-top: 8px;">
                        <a href="${displayUrl}" class="btn" style="width: 100%; text-align: left;">
                            <i class="material-icons" style="font-size: 18px;">download</i>
                            <span>${asset.name}</span>
                            <small style="margin-left: auto; opacity: 0.7;">${formatFileSize(asset.size)}</small>
                        </a>
                    </div>
                `;
            });
            
            div.innerHTML = `
                <div class="list-item-primary">
                    ${release.name || release.tag_name}
                    ${release.prerelease ? '<span class="chip chip-primary" style="margin-left: 8px;">预发布</span>' : ''}
                </div>
                <div class="list-item-secondary" style="margin-bottom: 12px;">
                    发布于 ${new Date(release.published_at).toLocaleDateString('zh-CN')}
                    ${platformTags}
                </div>
                ${release.body ? `<div style="margin-bottom: 16px; color: var(--md-on-surface-variant); font-size: 14px; line-height: 1.5;">${release.body}</div>` : ''}
                ${downloadLinks}
            `;
            
            return div;
        }

        function updateDownloadLinks() {
            const links = document.querySelectorAll('#releasesContainer .btn');
            links.forEach(link => {
                const originalHref = link.getAttribute('data-original-url') || link.href;
                link.setAttribute('data-original-url', originalHref);
                
                if (useMirror) {
                    link.href = originalHref.replace('github.com', 'bgithub.xyz');
                } else {
                    link.href = originalHref.replace('bgithub.xyz', 'github.com');
                }
            });
        }

        function setupPlatformFilter() {
            const select = document.getElementById('platformSelect');
            select.addEventListener('change', function() {
                const platform = this.value;
                filterReleasesByPlatform(platform);
            });
        }

        function filterReleasesByPlatform(platform) {
            if (platform === 'all') {
                displayReleases(releasesData);
                return;
            }
            
            const filtered = releasesData.filter(release => {
                const assets = release.assets || [];
                return assets.some(asset => {
                    const name = asset.name.toLowerCase();
                    if (platform === 'windows') {
                        return name.includes('.exe') || name.includes('.msi') || name.includes('windows');
                    } else if (platform === 'macos') {
                        return name.includes('.dmg') || name.includes('.pkg') || name.includes('macos');
                    } else if (platform === 'linux') {
                        return name.includes('.deb') || name.includes('.rpm') || name.includes('linux');
                    }
                    return true;
                });
            });
            
            displayReleases(filtered);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function updateLastUpdateTime() {
            const element = document.getElementById('lastUpdate');
            element.textContent = new Date().toLocaleString('zh-CN');
        }
    </script>
</body>
</html>
