<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenJDK-Android ä¸‹è½½</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="flex items-center gap-16 mb-24">
            <a href="index.html" class="btn btn-outline" style="padding: 8px 16px;">â† è¿”å›</a>
            <div>
                <h1 style="font-size: 24px; font-weight: 400;">OpenJDK-Android</h1>
                <p style="color: var(--md-on-surface-variant); font-size: 14px;">GitHub Actions æ„å»ºä¸‹è½½</p>
            </div>
        </header>
        
        <main>
            <div class="card mb-24">
                <div class="flex gap-16">
                    <div class="select-container">
                        <select id="versionSelect" class="select">
                            <option value="" disabled selected>é€‰æ‹© OpenJDK ç‰ˆæœ¬</option>
                            <option value="17">OpenJDK 17</option>
                            <option value="21">OpenJDK 21</option>
                            <option value="25">OpenJDK 25</option>
                            <option value="26">OpenJDK 26</option>
                            <option value="27">OpenJDK 27</option>
                        </select>
                    </div>
                    <button id="fetchBtn" class="btn" onclick="fetchBuilds()">è·å–æ„å»º</button>
                </div>
            </div>
            
            <div id="buildsContainer">
                <div class="empty-state">
                    <div class="icon">ğŸ“¦</div>
                    <p>é€‰æ‹©ç‰ˆæœ¬å¹¶è·å–æ„å»º</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const REPO_OWNER = 'Uniaball';
        const REPO_NAME = 'OpenJDK-Android';
        let cachedBuilds = {};
        
        async function fetchBuilds() {
            const version = document.getElementById('versionSelect').value;
            if (!version) {
                document.getElementById('buildsContainer').innerHTML = `
                    <div class="error-state">
                        <div class="icon">âš ï¸</div>
                        <p>è¯·å…ˆé€‰æ‹©ç‰ˆæœ¬</p>
                    </div>
                `;
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('buildsContainer').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è·å– OpenJDK ${version} æ„å»º...</p>
                </div>
            `;
            
            try {
                // å¦‚æœå·²ç¼“å­˜ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜
                if (cachedBuilds[version]) {
                    displayBuilds(cachedBuilds[version], version);
                    return;
                }
                
                // è·å– GitHub Actions runs
                const response = await fetch(
                    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs?per_page=50&sort=created&direction=desc`
                );
                
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : ${response.status})`);
                }
                
                const data = await response.json();
                
                // ç­›é€‰æŒ‡å®šç‰ˆæœ¬çš„æ„å»º
                const versionRuns = data.workflow_runs?.filter(run => {
                    const runName = run.name?.toLowerCase() || '';
                    return runName.includes(`jdk${version}`) || 
                           runName.includes(`openjdk${version}`) ||
                           runName.includes(`java${version}`);
                }) || [];
                
                if (versionRuns.length === 0) {
                    throw new Error(`æœªæ‰¾åˆ° OpenJDK ${version} çš„æ„å»º`);
                }
                
                // è·å–æ‰€æœ‰æ„å»ºçš„ artifacts
                const builds = [];
                
                // å¹¶å‘è·å–æ‰€æœ‰ artifacts
                const artifactPromises = versionRuns.slice(0, 20).map(async run => {
                    try {
                        const artifactsRes = await fetch(
                            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/artifacts`
                        );
                        
                        if (artifactsRes.ok) {
                            const artifactsData = await artifactsRes.json();
                            const artifacts = artifactsData.artifacts || [];
                            
                            artifacts.forEach(artifact => {
                                const nightlyLink = `https://nightly.link/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/${artifact.name}.zip`;
                                
                                builds.push({
                                    name: artifact.name,
                                    runId: run.id,
                                    createdAt: artifact.created_at,
                                    size: artifact.size_in_bytes,
                                    downloadUrl: nightlyLink,
                                    runNumber: run.run_number,
                                    conclusion: run.conclusion
                                });
                            });
                        }
                    } catch (error) {
                        console.warn(`è·å– artifacts å¤±è´¥: ${error.message}`);
                    }
                });
                
                await Promise.all(artifactPromises);
                
                if (builds.length === 0) {
                    throw new Error('æœªå‘ç°å¯ä¸‹è½½çš„æ„å»ºæ–‡ä»¶');
                }
                
                // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                builds.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // ç¼“å­˜ç»“æœ
                cachedBuilds[version] = builds;
                
                // æ˜¾ç¤ºæ‰€æœ‰æ„å»º
                displayBuilds(builds, version);
                
            } catch (error) {
                document.getElementById('buildsContainer').innerHTML = `
                    <div class="error-state">
                        <div class="icon">âš ï¸</div>
                        <p>${error.message}</p>
                        <button onclick="fetchBuilds()" class="btn" style="margin-top: 12px;">é‡è¯•</button>
                    </div>
                `;
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diff === 0) {
                return 'ä»Šå¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diff === 1) {
                return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 7) {
                return `${diff}å¤©å‰`;
            } else {
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            }
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return 'æœªçŸ¥';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function displayBuilds(builds, version) {
            const container = document.getElementById('buildsContainer');
            
            if (builds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <p>æœªæ‰¾åˆ° OpenJDK ${version} çš„æ„å»ºæ–‡ä»¶</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 16px; color: var(--md-on-surface-variant); font-size: 14px;">
                    æ‰¾åˆ° ${builds.length} ä¸ª OpenJDK ${version} æ„å»º
                </div>
            `;
            
            builds.forEach((build, index) => {
                const statusColor = build.conclusion === 'success' ? '#4CAF50' : '#F44336';
                const statusText = build.conclusion === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                
                html += `
                    <div class="list-item">
                        <div class="flex justify-between items-center">
                            <div style="flex: 1;">
                                <div class="list-item-primary">${build.name}</div>
                                <div class="list-item-secondary">
                                    <span>#${build.runNumber}</span>
                                    <span style="margin: 0 8px;">â€¢</span>
                                    <span>${formatDate(build.createdAt)}</span>
                                    <span style="margin: 0 8px;">â€¢</span>
                                    <span style="color: ${statusColor}">${statusText}</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: var(--md-on-surface-variant); font-size: 12px;">
                                    ${formatFileSize(build.size)}
                                </span>
                                <a href="${build.downloadUrl}" 
                                   class="btn" 
                                   style="padding: 8px 16px;"
                                   download="${build.name}.zip">
                                    ä¸‹è½½
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>
