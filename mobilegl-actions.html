<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobileGL Actions 下载</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="mb-24">
            <div>
                <h1 style="font-size: 32px; font-weight: 400; color: var(--md-primary);">MobileGL Actions</h1>
                <p style="color: var(--md-on-surface-variant); font-size: 14px;">GitHub Actions 构建下载</p>
            </div>
        </header>

        <main>
            <div class="card mb-24">
                <div class="flex gap-16">
                    <div class="select-container">
                        <select id="buildTypeSelect" class="select">
                            <option value="" disabled selected>选择构建类型</option>
                            <option value="espryt">Build MobileGL Espryt</option>
                            <option value="magma">Build MobileGL Magma</option>
                            <option value="magma-tmp">Build MobileGL Magma-tmp</option>
                        </select>
                    </div>
                    <button id="fetchBtn" class="btn" onclick="fetchBuilds()">获取构建</button>
                </div>
            </div>

            <div id="buildsContainer">
                <div class="empty-state">
                    <i class="material-icons" style="font-size: 48px; color: var(--md-on-surface-variant); margin-bottom: 16px;">inventory_2</i>
                    <p>选择构建类型并获取构建</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 悬浮返回按钮 -->
    <a href="index.html" class="fab-back">
        <i class="material-icons">arrow_back</i>
    </a>

    <script>
        const REPO_OWNER = 'Uniaball';
        const REPO_NAME = 'MobileGL';
        let cachedBuilds = {};

        // 构建类型与工作流名称的映射
        const workflowMapping = {
            'espryt': ['Build MobileGL', 'build.yml'],
            'magma': ['Build MobileGL Vulkan', 'build_vulkan.yml'],
            'magma-tmp': ['Build MobileGL Vulkan (TMP)', 'build_vulkan_tmp.yml']
        };

        async function fetchBuilds() {
            const buildType = document.getElementById('buildTypeSelect').value;
            if (!buildType) {
                document.getElementById('buildsContainer').innerHTML = `
                    <div class="error-state">
                        <i class="material-icons" style="font-size: 40px; color: #C62828; margin-bottom: 16px;">warning</i>
                        <p>请先选择构建类型</p>
                    </div>
                `;
                return;
            }

            const [workflowName, workflowFile] = workflowMapping[buildType];
            
            // 显示加载状态
            document.getElementById('buildsContainer').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在获取 ${workflowName} 构建...</p>
                </div>
            `;

            try {
                // 如果已缓存，直接使用缓存
                if (cachedBuilds[buildType]) {
                    displayBuilds(cachedBuilds[buildType], workflowName);
                    return;
                }

                // 获取 GitHub Actions runs
                const response = await fetch(
                    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs?per_page=50&sort=created&direction=desc`
                );

                if (!response.ok) {
                    throw new Error(`请求失败 (状态码: ${response.status})`);
                }

                const data = await response.json();

                // 筛选指定工作流的构建
                const workflowRuns = data.workflow_runs?.filter(run => {
                    const runName = run.name?.toLowerCase() || '';
                    const runPath = run.path?.toLowerCase() || '';
                    
                    // 根据工作流名称或文件路径筛选
                    return runName.includes(workflowName.toLowerCase()) || 
                           runPath.includes(workflowFile.toLowerCase());
                }) || [];

                if (workflowRuns.length === 0) {
                    throw new Error(`未找到 ${workflowName} 的构建`);
                }

                // 获取所有构建的 artifacts
                const builds = [];

                // 并发获取所有 artifacts（限制前20个运行）
                const artifactPromises = workflowRuns.slice(0, 20).map(async run => {
                    try {
                        const artifactsRes = await fetch(
                            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/artifacts`
                        );

                        if (artifactsRes.ok) {
                            const artifactsData = await artifactsRes.json();
                            const artifacts = artifactsData.artifacts || [];

                            artifacts.forEach(artifact => {
                                const nightlyLink = `https://nightly.link/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/${artifact.name}.zip`;

                                builds.push({
                                    name: artifact.name,
                                    runId: run.id,
                                    createdAt: artifact.created_at,
                                    size: artifact.size_in_bytes,
                                    downloadUrl: nightlyLink,
                                    runNumber: run.run_number,
                                    conclusion: run.conclusion,
                                    workflowName: run.name,
                                    branch: run.head_branch || 'unknown'
                                });
                            });
                        }
                    } catch (error) {
                        console.warn(`获取 artifacts 失败: ${error.message}`);
                    }
                });

                await Promise.all(artifactPromises);

                if (builds.length === 0) {
                    throw new Error('未发现可下载的构建文件');
                }

                // 按创建时间排序（最新的在前）
                builds.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // 缓存结果
                cachedBuilds[buildType] = builds;

                // 显示所有构建
                displayBuilds(builds, workflowName);

            } catch (error) {
                document.getElementById('buildsContainer').innerHTML = `
                    <div class="error-state">
                        <i class="material-icons" style="font-size: 40px; color: #C62828; margin-bottom: 16px;">warning</i>
                        <p>${error.message}</p>
                        <button onclick="fetchBuilds()" class="btn" style="margin-top: 12px;">重试</button>
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diff === 0) {
                return '今天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diff === 1) {
                return '昨天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 7) {
                return `${diff}天前`;
            } else {
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            }
        }

        function formatFileSize(bytes) {
            if (!bytes) return '未知';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = M
