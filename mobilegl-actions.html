<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobileGL Actions 下载</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="mb-24">
            <div>
                <h1 style="font-size: 32px; font-weight: 400; color: var(--md-primary);">MobileGL Actions</h1>
                <p style="color: var(--md-on-surface-variant); font-size: 14px;">GitHub Actions 构建下载</p>
            </div>
        </header>

        <main>
            <div class="card mb-24">
                <div class="flex gap-16">
                    <div class="select-container">
                        <select id="buildTypeSelect" class="select">
                            <option value="" disabled selected>选择构建类型</option>
                            <option value="Build MobileGL">Build MobileGL Espryt</option>
                            <option value="Build MobileGL Vulkan">Build MobileGL Magma</option>
                            <option value="Build MobileGL Vulkan (TMP)">Build MobileGL Magma-tmp</option>
                        </select>
                    </div>
                    <button id="fetchBtn" class="btn" onclick="fetchBuilds()">获取构建</button>
                </div>
            </div>

            <div id="buildsContainer">
                <div class="empty-state">
                    <i class="material-icons" style="font-size: 48px; color: var(--md-on-surface-variant); margin-bottom: 16px;">inventory_2</i>
                    <p>选择构建类型并获取构建</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 悬浮返回按钮 -->
    <a href="index.html" class="fab-back">
        <i class="material-icons">arrow_back</i>
    </a>

    <script>
        const REPO_OWNER = 'Uniaball';
        const REPO_NAME = 'MobileGL';
        let cachedBuilds = {};

        async function fetchBuilds() {
            const buildType = document.getElementById('buildTypeSelect').value;
            if (!buildType) {
                document.getElementById('buildsContainer').innerHTML = `
                    <div class="error-state">
                        <i class="material-icons" style="font-size: 40px; color: #C62828; margin-bottom: 16px;">warning</i>
                        <p>请先选择构建类型</p>
                    </div>
                `;
                return;
            }

            document.getElementById('buildsContainer').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在获取 ${buildType} 构建...</p>
                </div>
            `;

            try {
                if (cachedBuilds[buildType]) {
                    displayBuilds(cachedBuilds[buildType], buildType);
                    return;
                }

                const response = await fetch(
                    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs?per_page=50&sort=created&direction=desc`
                );

                if (!response.ok) {
                    throw new Error(`请求失败 (状态码: ${response.status})`);
                }

                const data = await response.json();

                const buildRuns = data.workflow_runs?.filter(run => {
                    const runName = run.name || '';
                    return runName.includes(buildType);
                }) || [];

                if (buildRuns.length === 0) {
                    throw new Error(`未找到 ${buildType} 的构建`);
                }

                const builds = [];

                const artifactPromises = buildRuns.slice(0, 20).map(async run => {
                    try {
                        const artifactsRes = await fetch(
                            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/artifacts`
                        );

                        if (artifactsRes.ok) {
                            const artifactsData = await artifactsRes.json();
                            const artifacts = artifactsData.artifacts || [];

                            artifacts.forEach(artifact => {
                                const nightlyLink = `https://nightly.link/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/${artifact.name}.zip`;

                                builds.push({
                                    name: artifact.name,
                                    runId: run.id,
                                    createdAt: artifact.created_at,
                                    size: artifact.size_in_bytes,
                                    downloadUrl: nightlyLink,
                                    runNumber: run.run_number,
                                    conclusion: run.conclusion
                                });
                            });
                        }
                    } catch (error) {
                        console.warn(`获取 artifacts 失败: ${error.message}`);
                    }
                });

                await Promise.all(artifactPromises);

                if (builds.length === 0) {
                    throw new Error('未发现可下载的构建文件');
                }

                builds.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                cachedBuilds[buildType] = builds;

                displayBuilds(builds, buildType);

            } catch (error) {
                document.getElementById('buildsContainer').innerHTML = `
                    <div class="error-state">
                        <i class="material-icons" style="font-size: 40px; color: #C62828; margin-bottom: 16px;">warning</i>
                        <p>${error.message}</p>
                        <button onclick="fetchBuilds()" class="btn" style="margin-top: 12px;">重试</button>
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diff === 0) {
                return '今天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diff === 1) {
                return '昨天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 7) {
                return `${diff}天前`;
            } else {
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            }
        }

        function formatFileSize(bytes) {
            if (!bytes) return '未知';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function displayBuilds(builds, buildType) {
            const container = document.getElementById('buildsContainer');

            if (builds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons" style="font-size: 40px; color: #C62828; margin-bottom: 16px;">warning</i>
                        <p>未找到 ${buildType} 的构建文件</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 16px; color: var(--md-on-surface-variant); font-size: 14px;">
                    找到 ${builds.length} 个 ${buildType} 构建
                </div>
            `;

            builds.forEach((build, index) => {
                const statusColor = build.conclusion === 'success' ? '#4CAF50' : '#F44336';
                const statusText = build.conclusion === 'success' ? '成功' : '失败';

                html += `
                    <div class="list-item">
                        <div class="flex justify-between items-center">
                            <div style="flex: 1;">
                                <div class="list-item-primary">${build.name}</div>
                                <div class="list-item-secondary">
                                    <span>#${build.runNumber}</span>
                                    <span style="margin: 0 8px;">•</span>
                                    <span>${formatDate(build.createdAt)}</span>
                                    <span style="margin: 0 8px;">•</span>
                                    <span style="color: ${statusColor}">${statusText}</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: var(--md-on-surface-variant); font-size: 12px;">
                                    ${formatFileSize(build.size)}
                                </span>
                                <a href="${build.downloadUrl}" 
                                   class="btn" 
                                   style="padding: 8px 16px;"
                                   download="${build.name}.zip">
                                    下载
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    </script>
</body>
</html>
