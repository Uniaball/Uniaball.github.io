<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenJDK Android 构建下载器</title>
    <!-- Beer CSS - Material Design 3 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/beercss@3.5.0/dist/cdn/beer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/beercss@3.5.0/dist/cdn/beer.min.js" type="module"></script>
    <style>
        :root {
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --surface: #FEF7FF;
            --on-surface: #1C1B1F;
        }
        
        body {
            background-color: var(--surface);
            color: var(--on-surface);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            font-family: 'Roboto', sans-serif;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 48px;
            padding-top: 32px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 400;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .controls {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        
        .builds-list {
            margin-top: 24px;
        }
        
        .build-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .build-item:hover {
            background-color: #f5f5f5;
        }
        
        .build-info {
            flex: 1;
        }
        
        .build-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .build-meta {
            font-size: 0.875rem;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background-color: #FFEBEE;
            color: #C62828;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .footer {
            text-align: center;
            margin-top: 48px;
            padding: 24px;
            color: #666;
            font-size: 0.875rem;
            border-top: 1px solid #eee;
        }
        
        .nightly-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .manual-download {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #eee;
        }
        
        .manual-inputs {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        
        .manual-input {
            flex: 1;
            min-width: 150px;
        }
        
        .info-box {
            background-color: #E8F5E9;
            border-left: 4px solid #4CAF50;
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        
        .info-box p {
            margin: 8px 0;
            color: #2E7D32;
        }
        
        .tab-container {
            margin-bottom: 24px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 24px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 16px;
            }
            
            .card {
                padding: 24px 16px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                width: 100%;
            }
            
            .build-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .manual-inputs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OpenJDK Android 构建</h1>
            <p>从 Uniaball/OpenJDK-Android 仓库下载最新构建版本</p>
            <p style="font-size: 0.9rem; color: #4CAF50; margin-top: 8px;">
                <i>check_circle</i> 使用 nightly.link 服务，无需 GitHub 登录即可下载
            </p>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('auto')">自动获取</button>
                <button class="tab-button" onclick="switchTab('manual')">手动下载</button>
                <button class="tab-button" onclick="switchTab('direct')">直接链接</button>
            </div>
            
            <!-- 自动获取标签页 -->
            <div id="tab-auto" class="tab-content active">
                <div class="card">
                    <h2 class="section-title">自动获取构建列表</h2>
                    <div class="info-box">
                        <p><strong>说明：</strong>此功能通过 GitHub API 获取可用的构建列表，然后使用 nightly.link 提供下载链接。</p>
                        <p>需要 GitHub API 调用以获取构建信息，但下载时无需登录。</p>
                    </div>
                    
                    <div class="controls">
                        <div class="control-group">
                            <label class="field">
                                <select id="versionSelect" class="border">
                                    <option value="" disabled selected>请选择 OpenJDK 版本</option>
                                    <option value="17">OpenJDK 17</option>
                                    <option value="21">OpenJDK 21</option>
                                    <option value="25">OpenJDK 25</option>
                                    <option value="26">OpenJDK 26</option>
                                    <option value="27">OpenJDK 27</option>
                                </select>
                            </label>
                        </div>
                        <button id="fetchBtn" class="button primary round" onclick="fetchBuilds()">
                            <i>search</i>
                            <span>获取构建</span>
                        </button>
                    </div>
                    
                    <div id="buildsContainer">
                        <div class="empty-state">
                            <p>请先选择 OpenJDK 版本并点击"获取构建"</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 手动下载标签页 -->
            <div id="tab-manual" class="tab-content">
                <div class="card">
                    <h2 class="section-title">手动下载构建</h2>
                    <div class="info-box">
                        <p><strong>说明：</strong>直接使用 nightly.link 服务下载，无需 GitHub API 调用。</p>
                        <p>需要从 GitHub Actions 页面获取 Run ID 和 Artifact 名称。</p>
                    </div>
                    
                    <div class="manual-download">
                        <div class="manual-inputs">
                            <div class="manual-input">
                                <label class="field">
                                    <input type="text" id="runId" class="border" placeholder="GitHub Run ID">
                                    <span class="label">Run ID</span>
                                </label>
                            </div>
                            <div class="manual-input">
                                <label class="field">
                                    <input type="text" id="artifactName" class="border" placeholder="Artifact 名称">
                                    <span class="label">Artifact 名称</span>
                                </label>
                            </div>
                        </div>
                        
                        <button class="button primary round" onclick="manualDownload()">
                            <i>download</i>
                            <span>生成下载链接</span>
                        </button>
                        
                        <div id="manualResult" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- 直接链接标签页 -->
            <div id="tab-direct" class="tab-content">
                <div class="card">
                    <h2 class="section-title">常用构建直接链接</h2>
                    <div class="info-box">
                        <p><strong>说明：</strong>以下是一些常用构建的 nightly.link 直接下载链接。</p>
                        <p>这些链接可能会过期，建议使用自动获取或手动下载功能。</p>
                    </div>
                    
                    <div class="builds-list">
                        <div class="build-item">
                            <div class="build-info">
                                <div class="build-name">OpenJDK 17 最新构建</div>
                                <div class="build-meta">需要从 GitHub Actions 获取最新的 Run ID</div>
                            </div>
                            <div>
                                <button class="button small round" onclick="showDirectLinkHelp()">
                                    <i>info</i>
                                    <span>如何获取</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="build-item">
                            <div class="build-info">
                                <div class="build-name">OpenJDK 21 最新构建</div>
                                <div class="build-meta">需要从 GitHub Actions 获取最新的 Run ID</div>
                            </div>
                            <div>
                                <button class="button small round" onclick="showDirectLinkHelp()">
                                    <i>info</i>
                                    <span>如何获取</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="build-item">
                            <div class="build-info">
                                <div class="build-name">OpenJDK 25 最新构建</div>
                                <div class="build-meta">需要从 GitHub Actions 获取最新的 Run ID</div>
                            </div>
                            <div>
                                <button class="button small round" onclick="showDirectLinkHelp()">
                                    <i>info</i>
                                    <span>如何获取</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="manual-download">
                        <h3 style="margin-bottom: 16px;">nightly.link URL 格式</h3>
                        <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
                            https://nightly.link/Uniaball/OpenJDK-Android/actions/runs/<strong>{run_id}</strong>/<strong>{artifact_name}</strong>.zip
                        </div>
                        <p style="margin-top: 12px; color: #666; font-size: 0.9rem;">
                            将 <strong>{run_id}</strong> 替换为 GitHub Actions Run ID，<strong>{artifact_name}</strong> 替换为 Artifact 名称
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>构建来自 <a href="https://github.com/Uniaball/OpenJDK-Android" target="_blank">Uniaball/OpenJDK-Android</a> 仓库的 GitHub Actions</p>
            <p>下载服务由 <a href="https://nightly.link" target="_blank">nightly.link</a> 提供，无需 GitHub 登录</p>
            <p>本页面仅提供下载功能，OpenJDK 构建由原仓库维护者提供</p>
        </div>
    </div>

    <script>
        // GitHub 仓库信息
        const REPO_OWNER = 'Uniaball';
        const REPO_NAME = 'OpenJDK-Android';
        
        // 缓存构建数据
        let cachedBuilds = {};
        
        // 标签页切换
        function switchTab(tabName) {
            // 更新按钮状态
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活选中的标签页
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        // 显示加载状态
        function showLoading(containerId = 'buildsContainer') {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>正在获取构建列表...</p>
                    </div>
                `;
            }
        }
        
        // 显示错误信息
        function showError(message, containerId = 'buildsContainer') {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="error">
                        <p><strong>错误:</strong> ${message}</p>
                        <p>请检查网络连接或稍后重试</p>
                    </div>
                `;
            }
        }
        
        // 显示空状态
        function showEmptyState(message = '没有找到可用的构建', containerId = 'buildsContainer') {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>${message}</p>
                    </div>
                `;
            }
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '未知大小';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 自动获取构建列表
        async function fetchBuilds() {
            const version = document.getElementById('versionSelect').value;
            
            if (!version) {
                alert('请先选择 OpenJDK 版本');
                return;
            }
            
            // 检查缓存
            if (cachedBuilds[version]) {
                displayBuilds(cachedBuilds[version], version);
                return;
            }
            
            showLoading();
            
            try {
                // 获取 GitHub Actions runs
                const response = await fetch(
                    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs?per_page=50`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`GitHub API 请求失败: ${response.status}`);
                }
                
                const data = await response.json();
                
                // 过滤包含版本号的 runs
                const versionRuns = data.workflow_runs.filter(run => {
                    const runName = run.name || '';
                    return runName.includes(`JDK${version}`) || 
                           runName.includes(`jdk${version}`) ||
                           runName.includes(`openjdk${version}`) ||
                           runName.includes(`Java${version}`);
                });
                
                if (versionRuns.length === 0) {
                    showEmptyState(`未找到 OpenJDK ${version} 的构建`);
                    return;
                }
                
                // 获取每个 run 的 artifacts
                const builds = [];
                
                for (const run of versionRuns.slice(0, 10)) {
                    try {
                        const artifactsResponse = await fetch(
                            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/artifacts`,
                            {
                                headers: {
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            }
                        );
                        
                        if (artifactsResponse.ok) {
                            const artifactsData = await artifactsResponse.json();
                            
                            if (artifactsData.artifacts && artifactsData.artifacts.length > 0) {
                                artifactsData.artifacts.forEach(artifact => {
                                    // 使用 nightly.link 生成下载链接
                                    const nightlyLink = `https://nightly.link/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/${artifact.name}.zip`;
                                    
                                    builds.push({
                                        id: artifact.id,
                                        name: artifact.name,
                                        runId: run.id,
                                        runName: run.name,
                                        createdAt: artifact.created_at,
                                        updatedAt: artifact.updated_at,
                                        sizeInBytes: artifact.size_in_bytes,
                                        downloadUrl: nightlyLink,
                                        workflowName: run.name,
                                        runNumber: run.run_number,
                                        status: run.status,
                                        conclusion: run.conclusion,
                                        headSha: run.head_sha ? run.head_sha.substring(0, 7) : 'N/A'
                                    });
                                });
                            }
                        }
                    } catch (error) {
                        console.warn(`获取 artifacts 失败: ${error.message}`);
                    }
                }
                
                if (builds.length === 0) {
                    showEmptyState(`OpenJDK ${version} 的构建没有可用的 artifacts`);
                    return;
                }
                
                // 按创建时间排序（最新的在前）
                builds.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // 缓存结果
                cachedBuilds[version] = builds;
                
                // 显示构建列表
                displayBuilds(builds, version);
                
            } catch (error) {
                console.error('获取构建失败:', error);
                showError(error.message);
            }
        }
        
        // 显示构建列表
        function displayBuilds(builds, version) {
            if (builds.length === 0) {
                showEmptyState();
                return;
            }
            
            let html = `
                <div class="builds-list">
                    <p style="margin-bottom: 16px; color: #666;">
                        找到 ${builds.length} 个 OpenJDK ${version} 构建
                        <span class="nightly-badge">nightly.link</span>
                    </p>
            `;
            
            builds.forEach(build => {
                const sizeFormatted = formatFileSize(build.sizeInBytes);
                const formattedDate = formatDate(build.createdAt);
                const statusColor = build.conclusion === 'success' ? '#4CAF50' : 
                                  build.conclusion === 'failure' ? '#F44336' : '#FF9800';
                const statusText = build.conclusion === 'success' ? '成功' :
                                 build.conclusion === 'failure' ? '失败' : '进行中';
                
                html += `
                    <div class="build-item">
                        <div class="build-info">
                            <div class="build-name">
                                ${build.name}
                                <span style="font-size: 0.75rem; color: #999; margin-left: 8px;">
                                    #${build.runNumber}
                                </span>
                            </div>
                            <div class="build-meta">
                                <span>${formattedDate}</span> • 
                                <span>${sizeFormatted}</span> • 
                                <span style="color: ${statusColor}">${statusText}</span> • 
                                <span>提交: ${build.headSha}</span>
                            </div>
                        </div>
                        <div>
                            <a href="${build.downloadUrl}" 
                               download="${build.name}.zip" 
                               class="button primary small round"
                               onclick="trackDownload('${build.name}', '${version}')"
                               target="_blank">
                                <i>download</i>
                                <span>下载</span>
                            </a>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            document.getElementById('buildsContainer').innerHTML = html;
        }
        
        // 手动下载功能
        function manualDownload() {
            const runId = document.getElementById('runId').value.trim();
            const artifactName = document.getElementById('artifactName').value.trim();
            
            if (!runId || !artifactName) {
                alert('请输入 Run ID 和 Artifact 名称');
                return;
            }
            
            // 生成 nightly.link URL
            const nightlyLink = `https://nightly.link/${REPO_OWNER}/${REPO_NAME}/actions/runs/${runId}/${artifactName}.zip`;
            
            const resultDiv = document.getElementById('manualResult');
            resultDiv.innerHTML = `
                <div class="info-box">
                    <p><strong>下载链接已生成：</strong></p>
                    <div style="margin: 12px 0; padding: 12px; background: #f5f5f5; border-radius: 4px; font-family: monospace; word-break: break-all;">
                        ${nightlyLink}
                    </div>
                    <a href="${nightlyLink}" 
                       download="${artifactName}.zip" 
                       class="button primary round"
                       target="_blank">
                        <i>download</i>
                        <span>立即下载</span>
                    </a>
                    <p style="margin-top: 12px; font-size: 0.9rem;">
                        <i>info</i> 此链接直接使用 nightly.link 服务，无需 GitHub API 调用
                    </p>
                </div>
            `;
        }
        
        // 显示直接链接帮助
        function showDirectLinkHelp() {
            alert(`如何获取最新构建：
1. 访问 https://github.com/Uniaball/OpenJDK-Android/actions
2. 找到最新的成功构建（绿色对勾）
3. 点击进入构建详情页
4. 在 URL 中找到 run_id（如：1234567890）
5. 在 Artifacts 部分找到 artifact 名称
6. 使用手动下载功能输入这些信息`);
        }
        
        // 跟踪下载
        function trackDownload(buildName, version) {
            console.log(`下载: ${buildName} (OpenJDK ${version})`);
            
            // 显示下载提示
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    z-index: 1000;
                    animation: fadeIn 0.3s;
                `;
                notification.innerHTML = `
                    <i>check_circle</i>
                    <span>开始下载: ${buildName}</span>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }, 100);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 添加 CSS 动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes fadeOut {
                    from { opacity: 1; transform: translateY(0); }
                    to { opacity: 0; transform: translateY(10px); }
                }
                .spinner {
                    display: inline-block;
                    width: 40px;
                    height: 40px;
                    border: 3px solid rgba(0,0,0,0.1);
                    border-radius: 50%;
                    border-top-color: var(--primary);
                    animation: spin 1s ease-in-out infinite;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // 添加快捷键支持
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.id === 'runId') {
                    document.getElementById('artifactName').focus();
                }
                if (e.key === 'Enter' && e.target.id === 'artifactName') {
                    manualDownload();
                }
            });
        });
    </script>
</body>
</html>
