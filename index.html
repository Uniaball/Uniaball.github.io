<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenJDK Android 构建下载器</title>
    <!-- Beer CSS - Material Design 3 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/beercss@3.5.0/dist/cdn/beer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/beercss@3.5.0/dist/cdn/beer.min.js" type="module"></script>
    <style>
        :root {
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --surface: #FEF7FF;
            --on-surface: #1C1B1F;
        }
        
        body {
            background-color: var(--surface);
            color: var(--on-surface);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            font-family: 'Roboto', sans-serif;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 48px;
            padding-top: 32px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 400;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .controls {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        
        .builds-list {
            margin-top: 24px;
        }
        
        .build-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .build-item:hover {
            background-color: #f5f5f5;
        }
        
        .build-info {
            flex: 1;
        }
        
        .build-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .build-meta {
            font-size: 0.875rem;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background-color: #FFEBEE;
            color: #C62828;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .footer {
            text-align: center;
            margin-top: 48px;
            padding: 24px;
            color: #666;
            font-size: 0.875rem;
            border-top: 1px solid #eee;
        }
        
        .nightly-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 16px;
            }
            
            .card {
                padding: 24px 16px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                width: 100%;
            }
            
            .build-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OpenJDK Android 构建</h1>
            <p>从 Uniaball/OpenJDK-Android 仓库下载最新构建版本</p>
        </div>
        
        <div class="card">
            <h2 class="section-title">选择版本</h2>
            <div class="controls">
                <div class="control-group">
                    <label class="field">
                        <select id="versionSelect" class="border">
                            <option value="" disabled selected>请选择 OpenJDK 版本</option>
                            <option value="17">OpenJDK 17</option>
                            <option value="21">OpenJDK 21</option>
                            <option value="25">OpenJDK 25</option>
                            <option value="26">OpenJDK 26</option>
                            <option value="27">OpenJDK 27</option>
                        </select>
                    </label>
                </div>
                <button id="fetchBtn" class="button primary round" onclick="fetchBuilds()">
                    <i>search</i>
                    <span>获取构建</span>
                </button>
            </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">可用构建</h2>
            <div id="buildsContainer">
                <div class="empty-state">
                    <p>请先选择 OpenJDK 版本并点击"获取构建"</p>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>构建来自 <a href="https://github.com/Uniaball/OpenJDK-Android" target="_blank">Uniaball/OpenJDK-Android</a> 仓库的 GitHub Actions</p>
            <p>下载服务由 <a href="https://nightly.link" target="_blank">nightly.link</a> 提供，无需 GitHub 登录</p>
        </div>
    </div>

    <script>
        const REPO_OWNER = 'Uniaball';
        const REPO_NAME = 'OpenJDK-Android';
        let cachedBuilds = {};
        const versionSelect = document.getElementById('versionSelect');
        const buildsContainer = document.getElementById('buildsContainer');
        
        function showLoading() {
            buildsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在获取构建列表...</p>
                </div>
            `;
        }
        
        function showError(message) {
            buildsContainer.innerHTML = `
                <div class="error">
                    <p><strong>错误:</strong> ${message}</p>
                </div>
            `;
        }
        
        function showEmptyState(message = '没有找到可用的构建') {
            buildsContainer.innerHTML = `
                <div class="empty-state">
                    <p>${message}</p>
                </div>
            `;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '未知大小';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function fetchBuilds() {
            const version = versionSelect.value;
            if (!version) {
                alert('请先选择 OpenJDK 版本');
                return;
            }
            
            if (cachedBuilds[version]) {
                displayBuilds(cachedBuilds[version], version);
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs?per_page=50`,
                    { headers: { 'Accept': 'application/vnd.github.v3+json' } }
                );
                
                if (!response.ok) throw new Error(`请求失败: ${response.status}`);
                
                const data = await response.json();
                const versionRuns = data.workflow_runs.filter(run => {
                    const runName = run.name || '';
                    return runName.includes(`JDK${version}`) || 
                           runName.includes(`jdk${version}`) ||
                           runName.includes(`openjdk${version}`) ||
                           runName.includes(`Java${version}`);
                });
                
                if (versionRuns.length === 0) {
                    showEmptyState(`未找到 OpenJDK ${version} 的构建`);
                    return;
                }
                
                const builds = [];
                for (const run of versionRuns.slice(0, 10)) {
                    try {
                        const artifactsResponse = await fetch(
                            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/artifacts`,
                            { headers: { 'Accept': 'application/vnd.github.v3+json' } }
                        );
                        
                        if (artifactsResponse.ok) {
                            const artifactsData = await artifactsResponse.json();
                            if (artifactsData.artifacts && artifactsData.artifacts.length > 0) {
                                artifactsData.artifacts.forEach(artifact => {
                                    const nightlyLink = `https://nightly.link/${REPO_OWNER}/${REPO_NAME}/actions/runs/${run.id}/${artifact.name}.zip`;
                                    builds.push({
                                        name: artifact.name,
                                        runId: run.id,
                                        createdAt: artifact.created_at,
                                        sizeInBytes: artifact.size_in_bytes,
                                        downloadUrl: nightlyLink,
                                        runNumber: run.run_number,
                                        conclusion: run.conclusion,
                                        headSha: run.head_sha ? run.head_sha.substring(0, 7) : 'N/A'
                                    });
                                });
                            }
                        }
                    } catch (error) {
                        console.warn(`获取 artifacts 失败: ${error.message}`);
                    }
                }
                
                if (builds.length === 0) {
                    showEmptyState(`OpenJDK ${version} 的构建没有可用的 artifacts`);
                    return;
                }
                
                builds.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                cachedBuilds[version] = builds;
                displayBuilds(builds, version);
                
            } catch (error) {
                console.error('获取构建失败:', error);
                showError(error.message);
            }
        }
        
        function displayBuilds(builds, version) {
            if (builds.length === 0) {
                showEmptyState();
                return;
            }
            
            let html = `
                <div class="builds-list">
                    <p style="margin-bottom: 16px; color: #666;">
                        找到 ${builds.length} 个 OpenJDK ${version} 构建
                        <span class="nightly-badge">nightly.link</span>
                    </p>
            `;
            
            builds.forEach(build => {
                const sizeFormatted = formatFileSize(build.sizeInBytes);
                const formattedDate = formatDate(build.createdAt);
                const statusColor = build.conclusion === 'success' ? '#4CAF50' : 
                                  build.conclusion === 'failure' ? '#F44336' : '#FF9800';
                const statusText = build.conclusion === 'success' ? '成功' :
                                 build.conclusion === 'failure' ? '失败' : '进行中';
                
                html += `
                    <div class="build-item">
                        <div class="build-info">
                            <div class="build-name">
                                ${build.name}
                                <span style="font-size: 0.75rem; color: #999; margin-left: 8px;">
                                    #${build.runNumber}
                                </span>
                            </div>
                            <div class="build-meta">
                                <span>${formattedDate}</span> • 
                                <span>${sizeFormatted}</span> • 
                                <span style="color: ${statusColor}">${statusText}</span> • 
                                <span>提交: ${build.headSha}</span>
                            </div>
                        </div>
                        <div>
                            <a href="${build.downloadUrl}" 
                               download="${build.name}.zip" 
                               class="button primary small round"
                               target="_blank">
                                <i>download</i>
                                <span>下载</span>
                            </a>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            buildsContainer.innerHTML = html;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .spinner {
                    display: inline-block;
                    width: 40px;
                    height: 40px;
                    border: 3px solid rgba(0,0,0,0.1);
                    border-radius: 50%;
                    border-top-color: var(--primary);
                    animation: spin 1s ease-in-out infinite;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
